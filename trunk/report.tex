\documentclass{article}
\usepackage[brazil]{babel}
\usepackage[utf8]{inputenc}

\title{\textbf{Relatório TP2}}
\author{\textbf{Grupo 1} \\
  Anderson Phillip Birocchi (072787) \\
  Miguel Francisco Alves de Mattos Gaiowski (076116) \\
  Raphael Kubo da Costa (072201)}
\date{\today}
\begin{document}

\maketitle

\section{Objetivo}\

Neste trabalho prático deve ser implementado um sistema de consulta por chaves primarias numa base de dados. A estrutura desta base é uma modificação da base feita no Trabalho Prático 1. Além da consulta, pede-se que o usuário tenha a possibilidade de gerar uma lista de todas as obras de arte na base de dados.

Este programa deve ser capaz de fazer tudo o que o da primeira versão fazia, adicionando-se as funcionalidades supra-citadas.

\section{Uso da interface}\

O programa gerado pelo \textit{Makefile} chama-se \textbf{tp2} e deve ser rodado a partir de um terminal. Seu menu inicial apresenta quatro opções: \textbf{inserir} uma nova entrada na base de dados, \textbf{consultar} uma obra existente no banco de dados, \textbf{gerar} uma lista com informações sobre todas as obras da base de dados e \textbf{sair}.

Cada opção é selecionada digitando-se \textbf{i} para inserir, \textbf{c} para consultar, \textbf{g} para gerar a lista de obras e \textbf{s} para sair.\\

No modo de \textbf{inserção}, o usuário deve digitar as informações para \textit{nome da obra}, \textit{tipo de obra}, \textit{autor da obra}, \textit{ano em que a obra foi feita}, \textit{valor da obra} e um \textit{identificador da obra}. Determinados campos possuem restrições: ano e valor devem conter apenas dígitos, e o identificador precisa terminar nas extensões \textit{png, jpg} ou \textit{gif} e ser precedido por até quatro dígitos. Caso já exista uma obra com mesmo nome na base de dados, o usuário deve entrar com outros dados de obra. Feita a inserção, o usuário pode escolher inserir uma nova obra ou voltar para o menu principal.\\

No modo de \textbf{consulta}, o usuário deve entrar com o nome da obra cujas informações deseja obter. Deve-se tomar atenção, pois a consulta é \textit{case-sensitive}, ou seja, diferencia maiúsculas e minúsculas. Caso uma obra com o título desejado seja encontrada, suas informações (título, tipo, autor, ano de criação, valor e identificador) são escritas no arquivo \textbf{lista.html} para exibição. Se não houver nenhuma obra com esse nome no banco de dados, é exibida uma mensagem de erro.\\

No modo de \textbf{geração de lista}, escreve-se no arquivo \textbf{lista.html} uma lista com as informações (título, tipo, autor, ano de criação, valor e identificador) de todas as obras cadastradas na base de dados. Caso não haja nenhuma obra na base de dados, exibe-se uma mensagem de erro.

\section{Descrição do Trabalho}\

Desde a versão anterior que foi definida uma divisão dos códigos fonte para melhor manutenção e escalabilidade. Com o crescimento das funcionalidades e necessidade de melhor base para algumas destas, acabou-se modificando a estrutura dos arquivos para melhor adequação. Atualmente, os seguintes arquivos compõem o programa:

\begin{itemize}
 \item \textbf{base.c, base.h}\\
       bbbb
\end{itemize}

O arquivo \textbf{base.h} contêm vários defines para tamanhos de campos. Ali define-se também a estrutura que carrega cada informação das obras de arte. Os cabeçalhos das funções correspondem àquelas implementadas em \textbf{base.c}. Essas funções fazem o básico, que é ler um registro da base de dados, escrever um registro na base e validar o campo identificador da imagem.

Os arquivos \textbf{io.c} e \textbf{io.h} controlam a leitura e escrita de dados entrados pelo usuário. Foi implementada também uma função para limpar os espaços em branco no começo e no fim da strings, além daqueles espaços duplicados no meio. Continuam todas as funções do Trabalho Prático 1 para validação de entrada.

Os arquivos \textbf{menu.c} e \textbf{menu.h} carregam as funções de impressão de boas vindas e do menu de opções para o usuário. A única modificação nesses arquivos foi a adição das opções de consulta e geração de lista de obras de arte.

O código contido em \textbf{main.c} contém a lógica de execução do programa, que deve imprimir o menu, sair caso esta seja a opção do usuário, ou inserir uma obra de arte perguntando, logo após, se deseja inserir outro registro. Ali foram adicionados os casos de consulta e listagem das obras de arte. Nesses casos, dali já são chamadas as funções que escrevem cabeçalhos e rodapés do arquivo \textbf{lista.html}, além das funções que buscam e gravam as informações dos registros.

Para melhor manutenção de código foram criados os arquivos \textbf{file.c} e \textbf{file.h}. Neles, pode-se encontrar funções para verificação da existência e checagem do tamanho de um arquivo.

Novos também, são \textbf{mem.c} e \textbf{mem.h}. Neste há definições de macros para maior facilidade no uso da função cujo cabeçalho também é definido ali. A finalidade de tudo isso é a clareza e facilidade para alocação dinâmica de memória.

Os fontes \textbf{html.h} e \textbf{html.c} são responsáveis pela escrita do arquivo de saída das consultas. Temos uma função que escreve o começo do \textit{html}, e outra que escreve o final. Entre as chamadas delas, pode-se chamar quantas vezes for necessário a função dedicada a escreves as informações de um único registro. Assim, com um simples loop podemos escrever as informações de quantas obras for necessário.

A principal adição deste Trabalho Prático é, com certeza, o conjunto \textbf{pk.h} e \textbf{pk.c}. Estes são responsáveis por toda a manipulação da estrutura de indexação com chaves primárias.

Em \textbf{pk.h} há definições dos tamanhos dos campos e da própria estrutura de chave primária. Esta contém um campo que é o número relativo do registro(RRN) e outro que é o nome completo da obra(chave primária). Além disso, foi criada uma estrutura que carrega o número de registros carregados na memória, o máximo de registros que podem ser carregados com a alocação de memória corrente, e o vetor de estruturas de chaves primárias. 

Uma decisão importante durante o desenvolvimento deste TP foi o de criar uma estrutura para as chaves primárias. Outra solução encontrada para problemas que tínhamos foi o de criar uma estrutura para carregas o vetor de estruturas de chaves primárias. Assim, fica muito fácil o controle de quantos registros existem e quantos podem existir sem precisar expandir o vetor.

Há funções para diversas finalidads relacionadas às chaves primárias. Inicialização das estruturas, liberação de memória, inserção são algumas. Além dessas, busca por uma chave, carregar o arquivo salvo das chaves primárias, montar as estruturas a partir de uma base de dados e escrever as informações da memória para o disco são outras.

Foi decidido por começar com um vetor de 20 posições para as chaves. Cada vez que esse vetor é preenchido, dobra-se o tamanho do mesmo.

\section{Resultado final}\

Conseguimos fazer um programa sem bugs conhecidos e sem vazamentos de memória encontrados. As consultas e listagem de obras funcionam perfeitamente.

As maiores dificuldades foram encontradas durante a implementaçãodas funções de manipulação de chaves primárias. Desde a escolha da melhor estrutura de dados até a perfeição do sistema de controle de alocação de memória encontramos várias possibilidades diferentes de implementação, e isso caracterizou boa parte do desafio desse Trabalho Prático.

A parte de geração de um arquivo \textit{html} foi de extrema facilidade, sendo que ainda assim causa uma melhoria muito grande na forma como o programa trabalha. O fato de poder ver as imagens num browser ao invés de só ver as informações num terminal deixou o resultado final muito mais interessante.

\end{document}
